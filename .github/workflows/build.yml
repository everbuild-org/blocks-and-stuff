name: Build, Test & Publish

on:
  push:
    branches: ["*"]
  pull_request:
    branches: ["*"]

env:
  JAVA_VERSION: '23'

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-disabled: false

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build Project
        run: ./gradlew build --no-daemon --stacktrace

      - name: Run Tests
        run: ./gradlew test --no-daemon --stacktrace

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: build-artifacts-${{ github.sha }}
          path: |
            **/build/libs/*.jar
            !**/build/libs/*-plain.jar
          retention-days: 30

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ github.sha }}
          path: |
            **/build/test-results/
            **/build/reports/tests/
          retention-days: 7

  publish-everbuild:
    name: Publish to Everbuild Maven
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    environment:
      name: everbuild-maven

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-disabled: false

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Verify Everbuild Maven Credentials
        run: |
          if [[ -z "${{ secrets.EVERBUILD_MAVEN_URL }}" ]]; then
            echo "âŒ EVERBUILD_MAVEN_URL secret not configured"
            exit 1
          fi
          if [[ -z "${{ secrets.EVERBUILD_MAVEN_USERNAME }}" ]]; then
            echo "âŒ EVERBUILD_MAVEN_USERNAME secret not configured"
            exit 1
          fi
          if [[ -z "${{ secrets.EVERBUILD_MAVEN_PASSWORD }}" ]]; then
            echo "âŒ EVERBUILD_MAVEN_PASSWORD secret not configured"
            exit 1
          fi
          echo "âœ… All Everbuild Maven credentials are configured"

      - name: Configure Everbuild Maven Repository
        run: |
          echo "ðŸ“ Configuring Everbuild Maven Repository..."
          cat >> gradle.properties << EOF
          everbuildMavenUrl=${{ secrets.EVERBUILD_MAVEN_URL }}
          everbuildMavenUsername=${{ secrets.EVERBUILD_MAVEN_USERNAME }}
          everbuildMavenPassword=${{ secrets.EVERBUILD_MAVEN_PASSWORD }}
          EOF
          echo "âœ… Configuration complete"

      - name: Build for Publishing
        run: |
          echo "ðŸ”§ Building project for publishing..."
          ./gradlew build --no-daemon --stacktrace
          echo "âœ… Build successful"

      - name: Publish to Everbuild Maven Repository
        run: |
          echo "ðŸ“¦ Publishing to Everbuild Maven Repository..."
          echo "Repository: ${{ secrets.EVERBUILD_MAVEN_URL }}"
          echo "Username: ${{ secrets.EVERBUILD_MAVEN_USERNAME }}"
          ./gradlew publish --no-daemon --stacktrace --info
          echo "âœ… Publishing completed successfully"

      - name: Verify Publication
        if: success()
        run: |
          echo "ðŸ” Verifying publication..."
          VERSION=$(./gradlew properties --no-daemon -q | grep "^version:" | cut -d' ' -f2)
          GROUP=$(./gradlew properties --no-daemon -q | grep "^group:" | cut -d' ' -f2)
          
          echo "ðŸ“‹ Publication Summary:"
          echo "  â”œâ”€ Group ID: $GROUP"
          echo "  â”œâ”€ Version: $VERSION"
          echo "  â”œâ”€ Repository: Everbuild Maven"
          echo "  â”œâ”€ Modules Published:"
          find . -name "build.gradle.kts" -not -path "./build.gradle.kts" | while read -r file; do
            module=$(dirname "$file" | sed 's|^\./||')
            echo "  â”‚  â””â”€ $module"
          done
          echo "  â””â”€ Artifacts: JAR, Sources, Javadoc, POM"
          echo ""
          echo "âœ… Publication to Everbuild Maven Repository verified"
          echo "ðŸ  Library is now available in your Maven repository"

  notify-status:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: [build, publish-everbuild]
    if: always()

    steps:
      - name: Build Success Notification
        if: needs.build.result == 'success' && needs.publish-everbuild.result == 'skipped'
        run: |
          echo "âœ… Build and tests completed successfully!"
          echo "â„¹ï¸  Publishing skipped (not main branch or not a push event)"
          echo "Branch: ${{ github.ref_name }}"
          echo "Event: ${{ github.event_name }}"

      - name: Publish Success Notification
        if: needs.build.result == 'success' && needs.publish-everbuild.result == 'success'
        run: |
          echo "ðŸŽ‰ Build, tests, and publishing completed successfully!"
          echo "ðŸ“¦ Blocks and Stuff library has been published to Everbuild Maven Repository"
          echo "ðŸ  The library is now available for use"
          echo ""
          echo "ðŸ“‹ Build Details:"
          echo "  â”œâ”€ Branch: ${{ github.ref_name }}"
          echo "  â”œâ”€ Commit: ${{ github.sha }}"
          echo "  â”œâ”€ Build: âœ… Success"
          echo "  â”œâ”€ Tests: âœ… Passed"
          echo "  â””â”€ Publishing: âœ… Success"

      - name: Failure Notification
        if: needs.build.result == 'failure' || needs.publish-everbuild.result == 'failure'
        run: |
          echo "âŒ Workflow failed!"
          echo ""
          echo "ðŸ“‹ Failure Details:"
          echo "  â”œâ”€ Branch: ${{ github.ref_name }}"
          echo "  â”œâ”€ Commit: ${{ github.sha }}"
          echo "  â”œâ”€ Build: ${{ needs.build.result == 'success' && 'âœ… Success' || 'âŒ Failed' }}"
          echo "  â””â”€ Publishing: ${{ needs.publish-everbuild.result == 'success' && 'âœ… Success' || needs.publish-everbuild.result == 'failure' && 'âŒ Failed' || 'â­ï¸ Skipped' }}"
          echo ""
          echo "ðŸ” Check the workflow logs for detailed error information"
          exit 1